<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Gestión - EFTA Ruido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .sidebar {
            transition: transform 0.3s ease-in-out;
        }
        .main-content {
            transition: margin-left 0.3s ease-in-out;
        }
        .view { display: none; }
        .view.active { display: block; }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        .bg-health-good { background-color: #22c55e; } /* green-500 */
        .bg-health-risk { background-color: #f97316; } /* orange-500 */
        .bg-health-danger { background-color: #ef4444; } /* red-500 */
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Contenedor Principal -->
    <div id="app-container" class="flex h-screen bg-gray-100">

        <!-- Barra Lateral (Sidebar) -->
        <aside id="sidebar" class="sidebar bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <i class="fas fa-chart-pie fa-2x"></i>
                <span class="text-2xl font-extrabold">EFTA Ruido</span>
            </a>
            
            <div class="px-4 mb-4">
                <p class="text-sm text-gray-400">Bienvenido,</p>
                <p id="userName" class="text-lg font-semibold">Usuario</p>
                <div class="mt-2">
                    <label for="role-switcher" class="text-xs text-gray-400">Cambiar Vista:</label>
                    <select id="role-switcher" class="w-full bg-gray-700 text-white rounded-md p-1 mt-1 text-sm">
                        <option value="admin">Administrador</option>
                        <option value="user">Profesional</option>
                    </select>
                </div>
            </div>

            <nav id="admin-nav">
                <a href="#" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-view="admin-dashboard">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard General
                </a>
                <a href="#" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-view="admin-projects">
                    <i class="fas fa-folder-open mr-2"></i>Proyectos
                </a>
                <a href="#" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-view="admin-approvals">
                    <i class="fas fa-check-circle mr-2"></i>Aprobaciones <span id="approval-count" class="bg-red-500 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center ml-2"></span>
                </a>
                 <a href="#" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-view="admin-invoicing">
                    <i class="fas fa-file-invoice-dollar mr-2"></i>Facturación
                </a>
            </nav>

            <nav id="user-nav" class="hidden">
                 <a href="#" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-view="user-dashboard">
                    <i class="fas fa-user-circle mr-2"></i>Mi Panel
                </a>
                <a href="#" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700" data-view="user-expenses">
                    <i class="fas fa-receipt mr-2"></i>Mis Rendiciones
                </a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <div class="main-content flex-1 flex flex-col overflow-hidden">
            <header class="flex justify-between items-center p-4 bg-white border-b">
                <button id="menu-button" class="md:hidden">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h1 id="view-title" class="text-2xl font-semibold">Dashboard General</h1>
                <div>
                    <i class="fas fa-bell text-gray-500"></i>
                </div>
            </header>
            
            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                
                <!-- VISTA: ADMIN DASHBOARD -->
                <div id="admin-dashboard" class="view active">
                    <!-- Contenido del Dashboard de Admin -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-500 text-sm font-medium">Proyectos Activos</h3>
                            <p class="text-3xl font-bold">5</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-500 text-sm font-medium">Presupuesto Total</h3>
                            <p class="text-3xl font-bold">$125.000.000</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-500 text-sm font-medium">Margen Promedio</h3>
                            <p class="text-3xl font-bold text-green-600">28%</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-500 text-sm font-medium">Rendiciones Pendientes</h3>
                            <p id="pending-expenses-widget" class="text-3xl font-bold text-orange-500">3</p>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Salud de Proyectos</h2>
                        <div id="admin-projects-summary-list" class="space-y-4">
                            <!-- Proyectos se insertan aquí dinámicamente -->
                        </div>
                    </div>
                </div>

                <!-- VISTA: ADMIN PROYECTOS -->
                <div id="admin-projects" class="view">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Listado de Proyectos</h2>
                            <button class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"><i class="fas fa-plus mr-2"></i>Nuevo Proyecto</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3">Proyecto</th>
                                        <th class="p-3">Cliente</th>
                                        <th class="p-3">Presupuesto</th>
                                        <th class="p-3">Gastos</th>
                                        <th class="p-3">Margen</th>
                                        <th class="p-3">Estado</th>
                                        <th class="p-3">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="admin-projects-table">
                                    <!-- Filas de proyectos se insertan aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VISTA: ADMIN DETALLE PROYECTO -->
                <div id="admin-project-detail" class="view">
                    <!-- Contenido se genera dinámicamente -->
                </div>
                
                <!-- VISTA: ADMIN APROBACIONES -->
                <div id="admin-approvals" class="view">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Rendiciones Pendientes de Aprobación</h2>
                        <div id="approvals-list" class="space-y-4">
                            <!-- Rendiciones pendientes se insertan aquí -->
                        </div>
                    </div>
                </div>

                <!-- VISTA: ADMIN FACTURACIÓN -->
                <div id="admin-invoicing" class="view">
                     <div class="bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Gestión de Facturación</h2>
                        <p class="text-gray-600 mb-4">Desde aquí se podrían generar y enviar facturas electrónicas (DTE) a los clientes, integrándose con el SII en Chile.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3">N° Factura</th>
                                        <th class="p-3">Proyecto</th>
                                        <th class="p-3">Cliente</th>
                                        <th class="p-3">Monto</th>
                                        <th class="p-3">Fecha Emisión</th>
                                        <th class="p-3">Estado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="p-3">101</td>
                                        <td class="p-3">Monitoreo Mina El Abra</td>
                                        <td class="p-3">Freeport-McMoRan</td>
                                        <td class="p-3">$15.000.000</td>
                                        <td class="p-3">15/07/2024</td>
                                        <td class="p-3"><span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs">Pagada</span></td>
                                    </tr>
                                     <tr>
                                        <td class="p-3">102</td>
                                        <td class="p-3">Estudio de Impacto Acústico</td>
                                        <td class="p-3">Constructora XYZ</td>
                                        <td class="p-3">$8.500.000</td>
                                        <td class="p-3">01/08/2024</td>
                                        <td class="p-3"><span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs">Enviada</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- VISTA: USER DASHBOARD -->
                <div id="user-dashboard" class="view">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-gray-500 text-sm font-medium">Mi Cuenta Corriente (Viáticos)</h3>
                            <p id="user-balance" class="text-4xl font-bold text-blue-600">$0</p>
                            <p class="text-gray-500 mt-2">Saldo disponible para gastos.</p>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-center">
                             <h3 class="text-gray-500 text-sm font-medium mb-2">Acciones Rápidas</h3>
                            <button id="quick-add-expense-btn" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 text-lg">
                                <i class="fas fa-plus-circle mr-2"></i>Rendir un Gasto
                            </button>
                        </div>
                    </div>
                    <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-xl font-semibold mb-4">Mis Proyectos Asignados</h2>
                        <div id="user-projects-list" class="space-y-4">
                            <!-- Proyectos del usuario se insertan aquí -->
                        </div>
                    </div>
                </div>
                
                <!-- VISTA: USER RENDICIONES -->
                <div id="user-expenses" class="view">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Historial de Mis Rendiciones</h2>
                            <button id="add-expense-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"><i class="fas fa-plus mr-2"></i>Nueva Rendición</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th class="p-3">Fecha</th>
                                        <th class="p-3">Proyecto</th>
                                        <th class="p-3">Descripción</th>
                                        <th class="p-3">Monto</th>
                                        <th class="p-3">Estado</th>
                                    </tr>
                                </thead>
                                <tbody id="user-expenses-table">
                                    <!-- Gastos del usuario se insertan aquí -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Modal para rendir gasto -->
    <div id="expense-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6">Rendir Gasto</h2>
            <form id="expense-form">
                <div class="mb-4">
                    <label for="expense-project" class="block text-sm font-medium text-gray-700">Proyecto</label>
                    <select id="expense-project" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <!-- Opciones de proyecto se llenan dinámicamente -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="expense-amount" class="block text-sm font-medium text-gray-700">Monto (CLP)</label>
                    <input type="number" id="expense-amount" placeholder="Ej: 15000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-4">
                    <label for="expense-description" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <input type="text" id="expense-description" placeholder="Ej: Cena equipo faena" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="mb-6">
                    <label for="expense-receipt" class="block text-sm font-medium text-gray-700">Adjuntar Boleta/Factura</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-camera fa-2x text-gray-400"></i>
                            <div class="flex text-sm text-gray-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none">
                                    <span>Sube un archivo</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only">
                                </label>
                                <p class="pl-1">o arrástralo aquí</p>
                            </div>
                            <p class="text-xs text-gray-500">PNG, JPG, PDF hasta 10MB</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancel-expense" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Enviar Rendición</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- MOCK DATA ---
        const users = {
            admin: { id: 1, name: 'Socio Administrador', role: 'admin' },
            user: { id: 2, name: 'Ana Contreras', role: 'user', balance: 350000 },
            user3: { id: 3, name: 'Carlos Rojas', role: 'user', balance: 200000 },
            user4: { id: 4, name: 'Beatriz Soto', role: 'user', balance: 150000 }
        };

        let projects = [
            { id: 1, name: 'Monitoreo Mina El Abra', client: 'Freeport-McMoRan', budget: 45000000, expenses: 31000000, team: [2,3] },
            { id: 2, name: 'Estudio de Impacto Acústico', client: 'Constructora XYZ', budget: 18000000, expenses: 15500000, team: [2] },
            { id: 3, name: 'Mediciones Central Nehuenco', client: 'Colbún S.A.', budget: 32000000, expenses: 19000000, team: [2,4] },
            { id: 4, name: 'Mapa de Ruido Santiago', client: 'Gobierno Regional', budget: 25000000, expenses: 26500000, team: [3] },
            { id: 5, name: 'Auditoría Ambiental', client: 'Viña Concha y Toro', budget: 5000000, expenses: 2000000, team: [2,4] },
        ];

        let expenses = [
            { id: 1, userId: 2, projectId: 1, description: 'Arriendo de sonómetro', amount: 120000, date: '2024-08-10', status: 'approved' },
            { id: 2, userId: 2, projectId: 1, description: 'Cena equipo en Calama', amount: 45000, date: '2024-08-11', status: 'approved' },
            { id: 3, userId: 2, projectId: 2, description: 'Transporte a terreno', amount: 25000, date: '2024-08-12', status: 'pending' },
            { id: 4, userId: 3, projectId: 4, description: 'Alojamiento', amount: 80000, date: '2024-08-13', status: 'pending' },
            { id: 5, userId: 2, projectId: 3, description: 'Combustible camioneta', amount: 55000, date: '2024-08-14', status: 'pending' },
            { id: 6, userId: 2, projectId: 5, description: 'Almuerzo con cliente', amount: 30000, date: '2024-08-15', status: 'rejected' },
        ];

        let currentUser = users.admin;

        // --- DOM ELEMENTS ---
        const roleSwitcher = document.getElementById('role-switcher');
        const views = document.querySelectorAll('.view');
        const navLinks = document.querySelectorAll('.nav-link');
        const viewTitle = document.getElementById('view-title');
        const userName = document.getElementById('userName');
        const adminNav = document.getElementById('admin-nav');
        const userNav = document.getElementById('user-nav');
        const approvalCount = document.getElementById('approval-count');
        const pendingExpensesWidget = document.getElementById('pending-expenses-widget');
        const expenseModal = document.getElementById('expense-modal');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const quickAddExpenseBtn = document.getElementById('quick-add-expense-btn');
        const cancelExpenseBtn = document.getElementById('cancel-expense');
        const expenseForm = document.getElementById('expense-form');
        const menuButton = document.getElementById('menu-button');
        const sidebar = document.getElementById('sidebar');

        // --- FUNCTIONS ---

        const formatCurrency = (amount) => new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(amount);

        const getProjectHealth = (project) => {
            const expenseRatio = project.expenses / project.budget;
            if (expenseRatio > 1) return { status: 'danger', text: 'Sobrepasado', colorClass: 'bg-health-danger' };
            if (expenseRatio > 0.85) return { status: 'risk', text: 'En Riesgo', colorClass: 'bg-health-risk' };
            return { status: 'good', text: 'En Control', colorClass: 'bg-health-good' };
        };

        const calculateMargin = (project) => {
            if (project.budget === 0) return 0;
            return ((project.budget - project.expenses) / project.budget) * 100;
        };
        
        const renderAdminDashboard = () => {
            const summaryList = document.getElementById('admin-projects-summary-list');
            summaryList.innerHTML = '';
            projects.forEach(p => {
                const health = getProjectHealth(p);
                const margin = calculateMargin(p);
                const progress = (p.expenses / p.budget) * 100;

                const projectEl = document.createElement('div');
                projectEl.className = 'border p-4 rounded-lg';
                projectEl.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-semibold">${p.name} <span class="text-sm text-gray-500 font-normal">- ${p.client}</span></p>
                            <p class="text-sm text-gray-600">Margen: <span class="${margin > 15 ? 'text-green-600' : 'text-red-600'}">${margin.toFixed(1)}%</span></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="status-dot ${health.colorClass}"></span>
                            <span>${health.text}</span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="flex justify-between text-sm text-gray-500 mb-1">
                            <span>${formatCurrency(p.expenses)}</span>
                            <span>${formatCurrency(p.budget)}</span>
                        </div>
                        <div class="progress-bar h-2.5">
                            <div class="progress ${health.colorClass}" style="width: ${Math.min(progress, 100)}%;"></div>
                        </div>
                    </div>
                `;
                summaryList.appendChild(projectEl);
            });
        };

        const renderAdminProjects = () => {
            const tableBody = document.getElementById('admin-projects-table');
            tableBody.innerHTML = '';
            projects.forEach(p => {
                const health = getProjectHealth(p);
                const margin = calculateMargin(p);
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3 font-medium">${p.name}</td>
                    <td class="p-3 text-gray-600">${p.client}</td>
                    <td class="p-3">${formatCurrency(p.budget)}</td>
                    <td class="p-3">${formatCurrency(p.expenses)}</td>
                    <td class="p-3 font-semibold ${margin > 15 ? 'text-green-600' : 'text-red-600'}">${margin.toFixed(1)}%</td>
                    <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${health.colorClass.replace('bg-health', 'bg')} text-white">${health.text}</span></td>
                    <td class="p-3"><button class="text-blue-600 hover:underline view-project-detail" data-project-id="${p.id}">Ver Detalle</button></td>
                `;
                tableBody.appendChild(row);
            });
             document.querySelectorAll('.view-project-detail').forEach(button => {
                button.addEventListener('click', (e) => {
                    const projectId = parseInt(e.target.dataset.projectId);
                    renderAdminProjectDetail(projectId);
                    switchView('admin-project-detail');
                });
            });
        };
        
        const renderAdminProjectDetail = (projectId) => {
            const project = projects.find(p => p.id === projectId);
            const detailView = document.getElementById('admin-project-detail');
            const health = getProjectHealth(project);
            const margin = calculateMargin(project);
            const projectExpenses = expenses.filter(e => e.projectId === projectId);

            detailView.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button class="back-to-projects text-blue-600 mb-4"><i class="fas fa-arrow-left mr-2"></i>Volver a Proyectos</button>
                    <h2 class="text-2xl font-bold">${project.name}</h2>
                    <p class="text-gray-500 mb-6">${project.client}</p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="border p-4 rounded-lg text-center">
                            <h4 class="text-gray-500 text-sm">Presupuesto</h4>
                            <p class="text-2xl font-bold">${formatCurrency(project.budget)}</p>
                        </div>
                        <div class="border p-4 rounded-lg text-center">
                            <h4 class="text-gray-500 text-sm">Total Gastos</h4>
                            <p class="text-2xl font-bold">${formatCurrency(project.expenses)}</p>
                        </div>
                         <div class="border p-4 rounded-lg text-center">
                            <h4 class="text-gray-500 text-sm">Margen Actual</h4>
                            <p class="text-2xl font-bold ${margin > 15 ? 'text-green-600' : 'text-red-600'}">${margin.toFixed(1)}%</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4">Registro de Gastos del Proyecto</h3>
                    <table class="w-full text-left">
                        <thead><tr class="bg-gray-100"><th class="p-3">Fecha</th><th class="p-3">Responsable</th><th class="p-3">Descripción</th><th class="p-3">Monto</th><th class="p-3">Estado</th></tr></thead>
                        <tbody>
                            ${projectExpenses.map(e => {
                                const user = Object.values(users).find(u => u.id === e.userId) || {name: 'Empresa'};
                                return `<tr class="border-b"><td class="p-3">${new Date(e.date).toLocaleDateString('es-CL')}</td><td class="p-3">${user.name}</td><td class="p-3">${e.description}</td><td class="p-3">${formatCurrency(e.amount)}</td><td class="p-3">${e.status}</td></tr>`
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;

            detailView.querySelector('.back-to-projects').addEventListener('click', () => switchView('admin-projects'));
        };

        const renderApprovals = () => {
            const list = document.getElementById('approvals-list');
            const pending = expenses.filter(e => e.status === 'pending');
            list.innerHTML = '';

            if (pending.length === 0) {
                list.innerHTML = '<p class="text-gray-500">No hay rendiciones pendientes.</p>';
                return;
            }

            pending.forEach(e => {
                const user = Object.values(users).find(u => u.id === e.userId);
                const project = projects.find(p => p.id === e.projectId);
                const item = document.createElement('div');
                item.className = 'border p-4 rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p><span class="font-semibold">${user.name}</span> solicita aprobar <span class="font-semibold">${formatCurrency(e.amount)}</span></p>
                        <p class="text-sm text-gray-600">Proyecto: ${project.name} - ${e.description}</p>
                    </div>
                    <div class="space-x-2">
                        <button class="approve-expense bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600" data-expense-id="${e.id}">Aprobar</button>
                        <button class="reject-expense bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600" data-expense-id="${e.id}">Rechazar</button>
                    </div>
                `;
                list.appendChild(item);
            });

            document.querySelectorAll('.approve-expense').forEach(btn => btn.addEventListener('click', handleApproval));
            document.querySelectorAll('.reject-expense').forEach(btn => btn.addEventListener('click', handleApproval));
        };
        
        const handleApproval = (event) => {
            const expenseId = parseInt(event.target.dataset.expenseId);
            const isApproved = event.target.classList.contains('approve-expense');
            const expense = expenses.find(e => e.id === expenseId);
            
            if (expense) {
                expense.status = isApproved ? 'approved' : 'rejected';
                
                // Si se aprueba, el gasto se suma al proyecto y se descuenta del viático del usuario
                if (isApproved) {
                    const project = projects.find(p => p.id === expense.projectId);
                    project.expenses += expense.amount;
                    
                    const user = Object.values(users).find(u => u.id === expense.userId);
                    if (user && user.balance) {
                        user.balance -= expense.amount;
                    }
                }
            }
            updateUI();
        };

        const renderUserDashboard = () => {
            document.getElementById('user-balance').textContent = formatCurrency(users.user.balance);
            const userProjectsList = document.getElementById('user-projects-list');
            userProjectsList.innerHTML = '';
            const userAssignedProjects = projects.filter(p => p.team.includes(users.user.id));
            
            userAssignedProjects.forEach(p => {
                const health = getProjectHealth(p);
                const item = document.createElement('div');
                item.className = 'border p-4 rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">${p.name}</p>
                        <p class="text-sm text-gray-600">${p.client}</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="status-dot ${health.colorClass}"></span>
                        <span>${health.text}</span>
                    </div>
                `;
                userProjectsList.appendChild(item);
            });
        };

        const renderUserExpenses = () => {
            const tableBody = document.getElementById('user-expenses-table');
            tableBody.innerHTML = '';
            const userExpenses = expenses.filter(e => e.userId === users.user.id);

            userExpenses.forEach(e => {
                const project = projects.find(p => p.id === e.projectId);
                const statusMap = {
                    pending: { text: 'Pendiente', class: 'bg-yellow-100 text-yellow-800' },
                    approved: { text: 'Aprobado', class: 'bg-green-100 text-green-800' },
                    rejected: { text: 'Rechazado', class: 'bg-red-100 text-red-800' },
                };
                const statusInfo = statusMap[e.status];
                const row = document.createElement('tr');
                row.className = 'border-b';
                row.innerHTML = `
                    <td class="p-3">${new Date(e.date).toLocaleDateString('es-CL')}</td>
                    <td class="p-3">${project.name}</td>
                    <td class="p-3">${e.description}</td>
                    <td class="p-3">${formatCurrency(e.amount)}</td>
                    <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${statusInfo.class}">${statusInfo.text}</span></td>
                `;
                tableBody.appendChild(row);
            });
        };
        
        const openExpenseModal = () => {
            const projectSelect = document.getElementById('expense-project');
            projectSelect.innerHTML = '';
            const userAssignedProjects = projects.filter(p => p.team.includes(users.user.id));
            userAssignedProjects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                projectSelect.appendChild(option);
            });
            expenseModal.classList.remove('hidden');
            expenseModal.classList.add('flex');
        };

        const closeExpenseModal = () => {
            expenseForm.reset();
            expenseModal.classList.add('hidden');
            expenseModal.classList.remove('flex');
        };

        const handleExpenseSubmit = (e) => {
            e.preventDefault();
            const newExpense = {
                id: expenses.length + 1,
                userId: currentUser.id,
                projectId: parseInt(document.getElementById('expense-project').value),
                amount: parseInt(document.getElementById('expense-amount').value),
                description: document.getElementById('expense-description').value,
                date: new Date().toISOString().split('T')[0],
                status: 'pending'
            };
            expenses.push(newExpense);
            closeExpenseModal();
            updateUI();
        };

        const switchView = (viewId, title) => {
            views.forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            const link = document.querySelector(`.nav-link[data-view="${viewId}"]`);
            if (link) {
                navLinks.forEach(l => l.classList.remove('bg-gray-700'));
                link.classList.add('bg-gray-700');
                viewTitle.textContent = link.textContent.trim();
            } else {
                 viewTitle.textContent = "Detalle del Proyecto";
            }
        };

        const updateUI = () => {
            userName.textContent = currentUser.name;
            const pendingCount = expenses.filter(e => e.status === 'pending').length;
            approvalCount.textContent = pendingCount;
            pendingExpensesWidget.textContent = pendingCount;

            if (currentUser.role === 'admin') {
                adminNav.classList.remove('hidden');
                userNav.classList.add('hidden');
                renderAdminDashboard();
                renderAdminProjects();
                renderApprovals();
            } else {
                adminNav.classList.add('hidden');
                userNav.classList.remove('hidden');
                renderUserDashboard();
                renderUserExpenses();
            }
        };
        
        const setupRole = (role) => {
            currentUser = users[role];
            if (role === 'admin') {
                switchView('admin-dashboard');
            } else {
                switchView('user-dashboard');
            }
            updateUI();
        };

        // --- EVENT LISTENERS ---
        roleSwitcher.addEventListener('change', (e) => {
            setupRole(e.target.value);
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = e.currentTarget.dataset.view;
                switchView(viewId);
            });
        });

        menuButton.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
        });

        addExpenseBtn.addEventListener('click', openExpenseModal);
        quickAddExpenseBtn.addEventListener('click', openExpenseModal);
        cancelExpenseBtn.addEventListener('click', closeExpenseModal);
        expenseForm.addEventListener('submit', handleExpenseSubmit);

        // --- INITIALIZATION ---
        setupRole('admin');
    });
    </script>
</body>
</html>
